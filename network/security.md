# Технический проект для выявления вредоносного ПО

Вредоносное ПО - это небезопасная или нежелательная программа, которая может нарушить целосность, конфидициальность, доступность пользовательских данных и устройства.  
В основном существует два способа распространения вредоносного ПО: через сетевое взаимодействие, через передачу файлов или запуск не доверенного ПО.  

## Среда функционирования

* Рабочии станции и сервера
* Архитектура amd64
* Linux (на базе debian), версия ядра 5.10 и старше

## Способ выявления вредоносного поведения

* Анализ входящего и исходящего сетевого трафика
* Анализ запускаемых приложений
* Анализ обращений к файловой системе на чтение/запись
* Анализ выполнения команд в командной оболочке

## User cases с использованием сетевых атак

1. Атака типа MITM (человек по середине) с подменной данных
2. Обращения на потенциально опасный ресурс
3. Передача cкрытых или вредоносных данных с использованием разрешенных протоколов
4. Сканирование сети
5. Использование уязвимостей в обработчиках сетевого трафика

### В качестве примера, будем использовать протокол DNS:  

1. Отправка DNS-запроса на недоверенный DNS-сервер
Описание атаки: Приложение пользователя отправляет DNS-запрос на недоверенный DNS-сервер, в результате чего происходит передача подменного IP-адреса запрашиваемого ресурса.  
Спсооб детекции на уровне приложений: Выявлять приложения которые открывают сетевой сокет в ОС, для отправки DNS-запросов.  
Способ детекции на уровне сети: Выявлять IP-адреса DNS-серверов к которым приложения отправляю DNS-запросы, с последующей оценкой уровня доверия в соответсвии с белыми и черными списками.  
Способ борьбы: Добавить правила межсетевого экрана для стандартного TCP/UDP порта, используемого для взаимодействия по DNS-протоколу, которое разрешает отправлять DNS-запросы на довереные DNS-сервера и запрещает на все остальные. Использование технологии DNSSEC.  
Ограничения: Данный подход не способен выявить DNS-запросы: если для отправки DNS-запросов используется не стандартные, но разрешенные порты (например, 22, 80, 443 и пр.), если используется DNS over HTTP, DNS over TLS, DNS over VPN.  

2. Атака типа MITM, при которой происходит подмена IP-адреса для запрашиваемого доменного имени
Описание атаки: Приложение пользователя отправляет DNS-запрос на доверенный DNS-сервер, но злоумышленик в ответе от доверенного DNS-сервере производит подмену IP-адреса запрашиваемого ресурса.  
Спсооб детекции на уровне приложений: Выявлять приложения которые открывают сетевой сокет в ОС, для отправки DNS-запросов.  
Способ детекции на уровне сети: При отсутсвии технологии DNSSEC, отсутсвует явный способ определить подмену.  
Способ борьбы: Использование технологии DNSSEC.  
Ограничения: Данный подход не способен выявить DNS-запросы: если для отправки DNS-запросов используется не стандартные, но разрешенные порты (например, 22, 80, 443 и пр.), если используется DNS over HTTP, DNS over TLS, DNS over VPN.  

3. Использование DNS-протокола для передачи данных
Описание атаки: Через .  
Спсооб детекции на уровне приложений: Выявлять приложения которые открывают сетевой сокет в ОС, для отправки DNS-запросов.  
Способ детекции на уровне сети: Анамальное оПри отсутсвии технологии DNSSEC, отсутсвует явный способ определить подмену.  
Способ борьбы: Использование технологии DNSSEC.  
Ограничения: Данный подход не способен выявить DNS-запросы: если для отправки DNS-запросов используется не стандартные, но разрешенные порты (например, 22, 80, 443 и пр.), если используется DNS over HTTP, DNS over TLS, DNS over VPN.  

https://www.akamai.com/blog/security/a-deep-dive-on-malicious-dns-traffic?roistat_visit=1195159  
https://unit42.paloaltonetworks.com/dns-tunneling-how-dns-can-be-abused-by-malicious-actors/?roistat_visit=1195159  
https://habr.com/ru/companies/varonis/articles/513160/?roistat_visit=1195159  
https://www.catchpoint.com/network-admin-guide/dns-tunneling?roistat_visit=1195159  
https://www.ietf.org/rfc/rfc1034.txt?roistat_visit=1195159  
https://www.netsurion.com/articles/5-types-of-dns-attacks-and-how-to-detect-them?roistat_visit=1195159  

## User cases изменения файлов

Получение доступа к системным файлам, например ```/etc/shadow```, ```/etc/hosts``` и т.д.

---
**Исходная задача:** Необходимо создать комплексный инструмент, способный анализировать и обнаруживать вредоносный сетевой трафик, включая трафик, передаваемый через протокол DNS, в операционной системе Linux. Инструмент также должен отслеживать процессы, вовлеченные в генерацию этого трафика, и процессы, которые пытаются изменить файлы в системе. Участникам необходимо разработать механизм для блокировки вредоносного трафика и предотвращения несанкционированных изменений файлов.  

Данную задачу можно разделить на следующие составляющие:
* Разработка модуля для отслеживания и блокировки сетевого трафика
* Разработка модуля для отслеживания открытых сетевых сокетов и запущенных процессов
* Разработка модуля для отслеживания и блокировки обращений к файловой системе на запись
* Оценка возможности отслеживания атак с использованием протокола DNS

Среда функционирования:
* Рабочие станции и сервера
* Архитектура amd64
* Linux (на базе debian), версия ядра 5.10 и старше

# Модуль для отслеживания и блокировки сетевого трафика

Существует достаточно много решений данной задачи:

## 1. Анализ в ядре linux через netfilter
Возможности: Выполнение отслеживания и фильтрации сетевых пакетов по заголовкам L2-L4 модели OSI (а также по битовой маске во вложении)  
Преимущества: Большая скорость обработки сетевых пакетов  
Недостатки: Ограниченные возможности для анализа сетевых пакетов, отсутствует фильтрация на уровне L5+ модели OSI  

## 2. Расширения возможностей ядра linux через модули
Возможности: Добавление новых возможностей по отслеживанию и фильтрации сетевого трафика  
Преимущества: Большая скорость обработки сетевых пакетов  
Недостатки: Ограниченные возможности по масштабированию и расширению функционала. Ошибки в модуле могут привести к падению самого ядра linux    

Готовые open source решения: l7-filter для iptables (https://l7-filter.sourceforge.net/)  

## 3. Расширения возможностей ядра linux через eBPF
Возможности: Добавлений новых возможностей по отслеживанию и фильтрации сетевого трафика  
Преимущества: Большая скорость обработки сетевых пакетов. Можно отправлять сетевые пакеты из kernel space в user space для регистрации и дополнительного анализ  
Недостатки: Ограниченные возможности по масштабированию и расширению функционала  

## 4. Копирование сетевых пакетов из kernel space в user space с последующим их анализом в user space
Возможности: Расширенные возможности сигнатурного и эвристического анализа в user space  
Преимущества: Можно реализовать анализ любой сложности (сигнатурный и эвристический)  
Недостатки: Потяря в скорости обработки сетевых пакетов, из-за копии сетевых пакетов из kernel space в user space  

Готовые open source решения: snort, suricata, zeek  
Данные решения имеют огромную базу правил для анализа, плюс пользователь сам может писать свои правила анализа сетевого трафика  
Ускорить обработку сетевого трафика, можно через расширения возможностей ядра, например есть open source решение: PF_ZERO (https://www.ntop.org/guides/pf_ring/zc.html)  
Также snort и suricata можно использовать в режиме IPS через iptables + NFQUEUE  

# Модуль для отслеживания открытых сетевых сокетов и запущенных процессов

Для сетевого взаимодействия приложение использует сетевой стек Linux. Список открытых сокетов и приложений которые их используют можно получить через ядра linux с использованием стандартных системных библиотек, которые используют netstat (пакет net-tools) и ss (пакет iproute2).  

Готовое open source решение: opensnitch (https://github.com/evilsocket/opensnitch/tree/master)  
Данное решение использует eBPF для отслеживания открытых сокетов и управления политиками доступа  

# Модуль для отслеживания и блокировки обращений к файловой системе на запись

Для ядра linux существуют достаточно много уже готовых LSM (модулей безопасности), которые содержат в себя перехватчики системных вызовов между user space и kernel space.  

Существуют два больших open source решения, с помощью которых можно решить данную задачу: SELinux и AppArmo.  
В Astra linux применяется своя модель разграничения доступа на основе мандатных политик.  

# Дополнительно

Приложения можно запускать в изолированной среде, например в песочницах или контейнерах.  
Готовое open source решение: FireJail  

# Оценка возможности отслеживания атак с использованием протокола DNS

1. Отправка DNS-запроса на недоваренный DNS-сервер

|||
|-|-|
| Описание атаки | Приложение отправляет DNS-запрос на недоваренный DNS-сервер, в результате чего происходит передача подменного IP-адреса запрашиваемого ресурса |
| Способ детекции | Выявлять IP-адреса DNS-серверов к которым приложения отправляю DNS-запросы, с последующей оценкой уровня доверия в соответствии с белыми и черными списками |
| Способ борьбы | Добавить правила межсетевого экрана для стандартного TCP/UDP порта, используемого для взаимодействия по DNS-протоколу, которое разрешает отправлять DNS-запросы на доверенные DNS-сервера и запрещает на все остальные |
| Ограничения | Данный подход не способен выявить DNS-запросы если для отправки DNS-запросов используется не стандартные, но разрешенные порты (например, 22, 80, 443 и пр.), если используется DNS over HTTP, DNS over TLS или DNS over VPN |

2. Атака типа MITM, при которой происходит подмена IP-адреса для запрашиваемого доменного имени

|||
|-|-|
| Описание атаки | Приложение отправляет DNS-запрос на доверенный DNS-сервер, но злоумышленник в ответе от доверенного DNS-сервере производит подмену IP-адреса запрашиваемого ресурса |
| Способ детекции | При отсутствии технологии DNSSEC, отсутствует явный способ определить подмену |
| Способ борьбы | Защита канала связи до доверенного DNS-сервера или использовать технологию DNSSEC |
| Ограничения | Необходимо иметь доверенную инфраструктуру |  

3. Использование DNS-протокола для передачи данных

|||
|-|-|
| Описание атаки | Через DNS-протокол возможна передача скрытых и вредоносных данных между DNS-сервером и DNS-клиентом (DNS туннель) |
| Способ детекции | Необходим доступ не только к заголовкам L3-L4 модели OSI, но и к данным внутри пакета. Определение структуры DNS-протокола исходя из RFC с определением типа ресурсной записи DNS. Выявления большого числа DNS-запросов между DNS-клиентом и DNS-сервером |
| Способ борьбы | Запрет передачи определенных типов ресурсной записи DNS (например, TXT в который можно передавать данные размером до 255 байт) |
| Ограничения | Передача данных, через тип ресурсной записи DNS "A", "A6", "AAAA" в битовой последовательности через IPv4 и IPv6 |
