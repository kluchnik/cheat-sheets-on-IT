# kernel

## Параметры

| Параметр | Описание | Текущий параметр | Рекомендованный параметр | |
| - | - | - | - | - |
| ulimit -n | Лимит открытых файлов | 1024 | 2000500 | в примерах встречается 65535 и 20000000 |
| cat /proc/sys/fs/file-max | This indicates that this Linux system allows files to be opened at the same time (that is, the total number of files opened by all users) | 922337203685477580 | ? | в примерах встречается 12000500 |
| cat /proc/sys/fs/nr_open | Лимит открытых дескрипторов | 1048576 | 2000500 | в примерах встречается 3000000 и 20000500 |
| cat /proc/sys/net/ipv4/ip_forward | Маршрутизация сетевых пакетов | 1 | 1 | |
| cat /proc/sys/net/ipv4/ip_local_port_range | Диапазон локальных портов, доступных для установки исходящих подключений | 32768 60999 | 10000 65535 | в примерах встречается 500 65535 |
| cat /proc/sys/net/ipv4/tcp_max_orphans | Определяет максимальное число допустимых в системе сокетов TCP, не связанных каким-либо идентификатором пользовательского файла | 8192 | 65536 | в примерах встречается 262144 |
| cat /proc/sys/net/ipv4/tcp_fin_timeout | Определяет время сохранения сокета в состоянии FIN-WAIT-2 после его закрытия локальной стороной | 60 | 10 | |
| cat /proc/sys/net/ipv4/tcp_keepalive_time | Переменная определяет как часто следует проверять соединение, если оно давно не используется. Значение переменной имеет смысл только для тех сокетов, которые были созданы с флагом SO_KEEPALIVE | 7200 | 1800 | |
| cat /proc/sys/net/ipv4/tcp_keepalive_intvl | Определяет интервал передачи проб | 75 | 15 | |
| cat /proc/sys/net/ipv4/tcp_keepalive_probes | Произведение tcp_keepalive_probes * tcp_keepalive_intvl определяет время, по истечении которого соединение будет разорвано при отсутствии откликов. По умолчанию установлен интервал 75 секунд, т.е., время разрыва соединения при отсутствии откликов составит приблизительно 11 минут | 9 | 5 | |
| cat /proc/sys/net/ipv4/tcp_max_syn_backlog | Определяет максимальное число запоминаемых запросов на соединение, для которых не было получено подтверждения от подключающегося клиента | 128 | 4096 | в примерах встречается 262144 |
| cat /proc/sys/net/ipv4/tcp_synack_retries | Определяет число попыток повтора передачи пакетов SYNACK для пассивных соединений TCP. Значение 5 соответствует приблизительно 180 секундам на выполнение попыток организации соединения | 5 | 1 | в примерах встречается 2 |
| cat /proc/sys/net/ipv4/tcp_mem | (минимум, режим нагрузки, максимум) cодержит общие настройки потребления памяти для протокола TCP. Эта переменная измеряется в страницах (обычно 4Кб), а не байтах. Минимум - ОС ничего не делает. Режим нагрузки - ОС активирует режим под нагрузкой, при котором старается ограничить память. Максимум - максимальное количество страниц памяти, разрешенное для всех TCP сокетов | 22803 30405 45606 | 50576 64768 98152 | в примерах встречается 383865 511820 2303190 |
| cat /proc/sys/net/ipv4/tcp_rmem | (минимум, по умолчанию, максимум) содержит 3 целых числа, определяющих размер приемного буфера сокетов TCP. Минимум - каждый сокет TCP имеет право использовать эту память по факту своего создания. Значение по умолчанию: количество памяти, допустимое для буфера приема сокета TCP по умолчанию. Максимум: максимальный размер буфера, который может быть автоматически выделен для приема сокету TCP. | 4096 131072 6291456 | ? | в примерах встречается 4096 87380 16777216 и 1024 4096 16384 |
| cat /proc/sys/net/ipv4/tcp_wmem | (минимум, по умолчанию, максимум) содержит 3 целых числа, определяющих размер передающего буфера сокетов TCP. Минимум - каждый сокет TCP имеет право использовать эту память по факту своего создания. Значение по умолчанию: количество памяти, допустимое для буфера передачи сокета TCP по умолчанию. Максимум: максимальный размер буфера, который может быть автоматически выделен для передачи сокету TCP. | 4096 16384 4194304 | ? | в примерах встречается 4096 65536 16777216 и 1024 4096 16384 |
| cat /proc/sys/net/ipv4/tcp_orphan_retries | определяет число неудачных попыток, после которого уничтожается соединение TCP, закрытое на локальной стороне | 0 | 0 | |
| cat /proc/sys/net/ipv4/tcp_syncookies | Разрешает/запрещает передачу так называемых syncookies вызывающему хосту в случае переполнения очереди SYN-пакетов для заданного сокета | 1 | 0 | |
| cat /proc/sys/net/netfilter/nf_conntrack_max | Максимальное количество соединений для работы механизма connection tracking (используется, например, iptables). При слишком маленьких значениях ядро начинает отвергать входящие подключения с соответствующей записью в системном логе | 65536 | 2000000 | |
| cat /proc/sys/net/ipv4/tcp_timestamps | Разрешает временные метки протокола TCP. Их наличие позволяет управлять работой протокола в условиях серьезных нагрузок (см. tcp_congestion_control) | 1 | 1 | |
| cat /proc/sys/net/ipv4/tcp_sack | Разрешить выборочные подтверждения протокола TCP. Опция необходима для эффективного использования всей доступной пропускной способности некоторых сетей | 1 | 1 | |
| cat /proc/sys/net/ipv4/tcp_congestion_control | Протокол, используемый для управления нагрузкой в сетях TCP | cubic | cubic | в примерах встречается htcp |
cat /proc/sys/net/ipv4/tcp_no_metrics_save | Не сохранять результаты измерений TCP соединения в кеше при его закрытии. В некоторых случаях помогает повысить производительность | 0 | 1 | |
| cat /proc/sys/net/ipv4/conf/all/rp_filter | Защита от IP-спуфинга | 0 | ? | в примерах встречается 1 |
| cat /proc/sys/net/ipv4/conf/default/rp_filter | Защита от IP-спуфинга | 0 | ? | в примерах встречается 1 |
| cat /proc/sys/net/ipv4/tcp_tw_reuse | Разрешаем повторное использование TIME-WAIT сокетов в случаях, если протокол считает это безопасным | 2 | 1 | |
| cat /proc/sys/net/ipv4/tcp_window_scaling | Разрешаем динамическое изменение размера окна TCP стека | 1 | 1 | в примерах встречается 0 |
| cat /proc/sys/net/ipv4/tcp_rfc1337 | Защита от TIME_WAIT атак | 0 | ? | в примерах встречается 1 |
| cat /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts | Не отвечать на ICMP ECHO запросы, переданные широковещательными пакетами | 1 | 1 | |
| cat /proc/sys/net/ipv4/icmp_echo_ignore_all | Не отвечать на ICMP запросы | 0 | 0 | |
| cat /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses | Не отвечаем на ошибочно сформированные сообщения | 1 | 1
| cat /proc/sys/net/core/somaxconn | Максимальное число открытых сокетов, ждущих соединения. Имеет смысл увеличить значение по умолчанию. | 128 | 65535 | в примерах встречается 262144 |
| cat /proc/sys/net/core/netdev_max_backlog | Параметр определяет максимальное количество пакетов в очереди на обработку, если интерфейс получает пакеты быстрее, чем ядро может их обработать | 1000 | 1000 | в примерах встречается 30000 |
| cat /proc/sys/net/core/rmem_default | Размер буфера приема данных по умолчанию для всех соединений | 212992 | ? | в примерах встречается 65536 |
| cat /proc/sys/net/core/wmem_default | Размер буфера передачи данных по умолчанию для всех соединений | 212992 | ? | в примерах встречается 65536 |
| cat /proc/sys/net/core/rmem_max | Максимальный размер буфера приема данных для всех соединений | 212992 | ? | в примерах встречается 16777216 и 16384 |
| cat /proc/sys/net/core/wmem_max | Максимальный размер буфера передачи данных для всех соединений | 212992 | ? | в примерах встречается 16777216 и 16384 |
| cat /proc/sys/net/ipv4/tcp_syn_retries | Количество попыток передачи SYN-пакета при установлении нового соединения. Значение по-умолчанию - 5, что соответствует, примерно, 180 секундам | 6 | 2 | |
| cat /proc/sys/net/ipv4/tcp_moderate_rcvbuf | If set, TCP performs receive buffer auto-tuning, attempting to automatically size the buffer | 1 | ? | |

## driver

#### video

| Device Drivers | Graphics support |
|-|-|
| fbcon | CONFIG_FRAMEBUFFER_CONSOLE |
| vga16fb | CONFIG_FB_VGA16 |
| vesafb | CONFIG_FB_VESA |
| efifb | CONFIG_FB_EFI |
| modedb | DRM драйвера понимают единый синтаксис параметра video |
| fbdev | video driver for framebuffer device |

**vesafb**
Требует VESA BIOS Extensions (VBE) 2.0 и выше, управляется через параметр ядра vga (legacy!).  
Также через video=vesafb:option можно передавать дополнительные опции.  
```
    | 640x480  800x600  1024x768 1280x1024
----+-------------------------------------
256 |  0x301    0x303    0x305    0x307
32k |  0x310    0x313    0x316    0x319
64k |  0x311    0x314    0x317    0x31A
16M |  0x312    0x315    0x318    0x31B
```  

**efifb**
Работает через GOP.  
video=efifb:options, в основном для всяких там маков.  

**DRM**
API ядра для взаимодействия с графическими картами. Да, графика в ядре, привет, Майкрософт.  

DRM consists of:  
* KMS (Kernel Mode Setting) - Change resolution and depth  
* DRI (Direct Rendering Infrastructure) - Interfaces to access hardware directly  
* GEM (Graphics Execution Manager) - Buffer management  
* DRM Driver in kernel side - Access hardware  

sysfs entries:  
* /sys/class/drm  
* /sys/module/drm  

**KMS**
Kernel Mode Setting (KMS) — настройка разрешения экрана и глубины цвета средствами ядра, появилась в ядре в версии 2.6.29.  
KMS является развитем DRM.  
Отключается параметром ядра nomodeset.  
Можно управлять видеорежимом через параметр ядра:  
```
video=<conn>:<xres>x<yres>[M][R][-<bpp>][@<refresh>][i][m][eDd]
    <conn>: Connector, e.g. DVI-I-1, see /sys/class/drm/ for available connectors
    <xres> x <yres>: resolution
    M: compute a CVT mode?
    R: reduced blanking?
    -<bpp>: color depth
    @<refresh>: refresh rate
    i: interlaced (non-CVT mode)
    m: margins?
    e: output forced to on
    d: output forced to off
    D: digital output forced to on (e.g. DVI-I connector)
```

**fbdev**

https://www.x.org/archive/X11R6.8.0/doc/fbdev.4.html  
tools: fbset  
```
Section "Device" 
  Identifier "devname" 
  Driver "fbdev" 
  Option "fbdev" "/dev/fb1" 
  ...
EndSection
```  

# initrd

Распаковка: ```zcat ../kmdz.igz | cpio -i -d -H newc --no-absolute-filenames```  
Упаковка: ```find . | cpio -oH newc | gzip -9c > ../kmdz.igz```  
