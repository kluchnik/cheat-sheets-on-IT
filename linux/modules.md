# Модули ядра Linux

## Управление модулями ядра Linux

###  Загрузка

| Утилита | Описание | Применение |
| - | - | - |
| ```insmod``` | Загружает конкретный файл с расширением "ko", при этом, если модуль зависит от других модулей, еще не загруженных в ядро, команда выдаст ошибку, и не загрузит модуль. **Все зависимости придется подгружать вручную.** | Файл модуля подгружается из произвольного места файловой системы (например, пользователь скомпилировал модули и перед переносом в дерево ядра решил проверить его работоспособность). |
| ```modprobe``` | Работает только с деревом модулей, и возможна загрузка только оттуда по имени модуля, а не по имени файла. | Подгрузка уже готовых модулей, включенных в дерево модулей текущей версии ядра. |

Пример:
```
$ insmod /lib/modules/2.6.38-gentoo-r1/kernel/drivers/net/wireless/rt2x00/rt73usb.ko nohwcrypt=0
$ modprobe rt73usb nohwcrypt=0
```
### Обновления дерева модулей
Действия:
- скопировать модуль в дерево модулей текущего ядра
- обновить зависимости модулей команд ```depmod``` - программа пройдется рекурсивно по дереву модулей и запишет все зависимости в файл ```modules.dep```, который, в последствие, будет анализироваться командой ```modprobe```

### Состояние
После загрузки модуля можно проверить его наличие в списке загруженных в ядро модулей при помощи команды ```lsmod```
```
$ lsmod | grep rt73usb

Module    Size  Used by
rt73usb   17305 0
crc_itu_t 999   1       rt73usb
rt2x00usb 5749  1       rt73usb
rt2x00lib 19484 2       rt73usb,rt2x00usb
```
Из вывода команды видно, что модуль подгружен, а так же в своей работе использует другие модули.

### Выгрузка
Чтобы его выгрузить, можно воспользоваться командой ```rmmod``` или ```modprobe -r```.  
В качестве параметра обоим командам нужно передать только имя модуля.  
Если модуль не используется, то он будет выгружен, а если используется - будет выдана ошибка, и придется выгружать все модули, которые от него зависят.  
```
$ rmmod rt2x00usb
ERROR: Module rt2x00usb is in use by rt73usb

$ rmmod rt73usb
$ rmmod rt2x00usb
```
После выгрузки модуля все возможности, которые он предоставлял, будут удалены из таблицы ядра.  

### Логирование

При появлении малейших неполадок с модулем, нужно смотреть сообщения ядра.  
Они выводятся по команде ```dmesg``` и, в зависимости от настроек syslog, в файл ```/var/log/messages```.  
Сообщения ядра могут быть информативными или отладочными, что поможет определить проблему в процессе работы модуля, а могут сообщать об ошибке работы с модулем, например недостаточности символов и зависимостей, некорректных переданных параметрах.  

Например, модуль ```rt73usb``` требует параметр типа bool, что говорит о том, что параметр может принимать либо "0", либо "1":
```
$ modprobe rt73usb nohwcrypt=2
FATAL: Error inserting rt73usb (/lib/modules/2.6.38-gentoo-r1/kernel/drivers/net/wireless/rt2x00/rt73usb.ko): Invalid argument
```
Ошибка "Invalid argument" может говорить о чем угодно, саму ошибку ядро на консоль написать не может, только при помощи функции ```printk``` записать в системный лог.  
Посмотрев логи можно уже узнать в чем ошибка:
```
$ dmesg | tail -n1
rt73usb: `2' invalid for parameter `nohwcrypt'
```
В этом примере выведена только последняя строка с ошибкой. Модуль может написать и несколько строк, поэтому лучше выводить полный лог, или хотя бы последние строк десять.  

## Сборка модуля ядра Linux
Требования:
- исходники модуля ядра Linux
- среда сборки (например "gcc")
- необходимые пакеты для сборки
- заголовочный файл ядра - модули ядра всегда собираются с ядром, используя его заголовочные файлы, т.к. любое отклонение и несоответствие версий модуля и загруженного ядра ведет к невозможности загрузить этот модуль в ядро. В большинстве дистрибутивов это пакеты ```kernel-headers``` и/или ```kernel-devel```.  

При обновлении ядра этот модуль работать не будет. Нужны будут новые заголовочные файлы и потребуется заново пересобрать модуль.  
