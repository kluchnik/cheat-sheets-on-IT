# Linux bonding

 mode — определяет политику поведения объединенных интерфейсов. Возможные значения:

| mode | | Описание |
| - | - | - |
| balance-rr | 0 | Политика round-robin. Пакеты отправляются последовательно, начиная с первого доступного интерфейса и заканчивая последним. Эта политика применяется для балансировки нагрузки и отказоустойчивости. | 
| active-backup | 1 | Политика активный-резервный. Только один сетевой интерфейс из объединённых будет активным. Другой интерфейс может стать активным, только в том случае, когда упадёт текущий активный интерфейс. При такой политике MAC адрес bond интерфейса виден снаружи только через один сетевой порт, во избежание появления проблем с коммутатором. Эта политика применяется для отказоустойчивости. |
| balance-xor | 2 | Политика XOR. Передача распределяется между сетевыми картами используя формулу: («MAC адрес источника» XOR «MAC адрес назначения») по модулю «число интерфейсов». Получается одна и та же сетевая карта передаёт пакеты одним и тем же получателям. Опционально распределение передачи может быть основано и на политике «xmit_hash».  Политика XOR применяется для балансировки нагрузки и отказоустойчивости. |
| broadcast | 3 | Широковещательная политика. Передает всё на все сетевые интерфейсы. Эта политика применяется для отказоустойчивости. |
| 802.3ad | 4 | Политика агрегирования каналов по стандарту IEEE 802.3ad. Создаются агрегированные группы сетевых карт с одинаковой скоростью и дуплексом. При таком объединении передача задействует все каналы в активной агрегации, согласно стандарту IEEE 802.3ad. Выбор через какой интерфейс отправлять пакет определяется политикой, по умолчанию XOR политика, можно использовать «xmit_hash» политику. Требования: 1. Поддержка Ethtool в драйвере, для получения информации о скорости и дуплексе на каждом сетевом интерфейсе; 2. Поддержка на коммутаторе стандарта IEEE 802.3ad; 3. Настройка на коммутаторе. |
| balance-tlb | 5 | Политика адаптивной балансировки нагрузки передачи. Исходящий трафик распределяется в зависимости от загруженности каждой сетевой карты (определяется скоростью загрузки). Не требует дополнительной настройки на коммутаторе. Входящий трафик приходит на текущую сетевую карту. Если она выходит из строя, то другая сетевая карта берёт себе MAC адрес вышедшей из строя карты. Требования: 1. Поддержка Ethtool в драйвере, для получения информации о скорости загрузки на каждом сетевом интерфейсе. |
| balance-alb | 6 | Политика адаптивной балансировки нагрузки. Включает в себя политику balance-tlb плюс осуществляет балансировку входящего трафика. Не требует дополнительной настройки на коммутаторе. Балансировка входящего трафика достигается путём ARP переговоров. Драйвер bonding перехватывает ARP ответы, отправляемые с локальных сетевых карт наружу, и переписывает MAC адрес источника на один из уникальных MAC адресов сетевой карты, участвующей в объединении. Таким образом различные пиры используют различные MAC адреса сервера. Балансировка входящего трафика распределяется последовательно (round-robin) между интерфейсами. Требования: 1. Поддержка Ethtool в драйвере, для получения информации о скорости загрузки на каждом сетевом интерфейсе. 2. Поддержка в драйвере замены MAC адреса на включенном устройстве. 3. Возможно придётся корректировать значение параметра updelay равным или большим, чем значение задержки на коммутаторе (что бы ARP ответы небыли заблокированы на коммутаторе при переподключении линка, либо при добавлении новой сетевой карты в bonding). |
 
 ## Пример
 ```
┌───────────┬─────┬───────────┐       ┌───────────┐     ┌───────────┐
│ route 1-1 │     │ route 2-1 │       │ route 1-1 │  ┌──┤ route 2-1 │
└───────────┴──┐  └───────────┘       └───────────┘  │  └───────────┘
                │                  +                  │
┌───────────┐  │  ┌───────────┐       ┌───────────┬──┘  ┌───────────┐
│ route 1-2 │  └──┤ route 2-2 │       │ route 1-2 │     │ route 2-2 │
└───────────┘     └───────────┘       └───────────┴─────┴───────────┘
 ```
### route 1-1
| Интерфейс | IP-адрес |
| - | - |
| eth2 | N/A |
| eth3 | N/A |
| bond0 | 192.168.11.2 |

```
$ modprobe bonding mode=1 arp_interval=100 arp_ip_target=192.168.11.1
$ ifconfig bond0 192.168.11.2 netmask 255.255.255.0
$ ifenslave bond0 eth2
$ ifenslave bond0 eth3
 ```
 ### route 1-2
| Интерфейс | IP-адрес |
| - | - |
| eth2 | N/A |
| eth3 | N/A |
| bond0 | 192.168.11.2 |

```
$ modprobe bonding mode=1 arp_interval=100 arp_ip_target=192.168.11.1
$ ifconfig bond0 192.168.11.2 netmask 255.255.255.0
$ ifenslave bond0 eth2
$ ifenslave bond0 eth3
 ```
 ### route 2-1
| Интерфейс | IP-адрес |
| - | - |
| eth2 | N/A |
| eth3 | N/A |
| bond0 | 192.168.11.1 |

```
$ modprobe bonding mode=1 arp_interval=100 arp_ip_target=192.168.11.2
$ ifconfig bond0 192.168.11.1 netmask 255.255.255.0
$ ifenslave bond0 eth2
$ ifenslave bond0 eth3
 ```
  ### route 2-2
| Интерфейс | IP-адрес |
| - | - |
| eth2 | N/A |
| eth3 | N/A |
| bond0 | 192.168.11.1 |

```
$ modprobe bonding mode=1 arp_interval=100 arp_ip_target=192.168.11.2
$ ifconfig bond0 192.168.11.1 netmask 255.255.255.0
$ ifenslave bond0 eth2
$ ifenslave bond0 eth3
 ```
