# Сборка deb-пакета

## Создание deb-пакета из команды ```make install```

Создание deb-пакета из команды ```make install``` можно создать с использованием утилиты [CheckInstall](http://www.asic-linux.com.mx/~izto/checkinstall/).

CheckInstall поддерживает:  
* скрипты, выполняющиеся до и после установки пакета
* автоматическое управление конфигурационными файлами: пакет не позволит затереть старые конфиги новыми без спроса
* работа с шаблонами: возможность задавать пользователю вопросы при установке
* изменение файлов других пакетов

## Создание кастомного deb-пакета

[Debian Policy Manual](https://www.debian.org/doc/debian-policy/)

### 1. Утснаовка зависимотей
```
$ sudo apt-get install dpkg debconf debhelper lintian
```
### 2. Подготовка директории
```
$ mkdir ~/mydeb
$ mkdir -p ~/mydeb/DEBIAN
```
### 3. Создание необходимой структуры каталогов и файлов
Данная структура будет применена после установки пакета
```
$ mkdir -p ~/mydeb/home/user
$ echo 'test file' > ~/mydeb/home/user/test.txt
```
```
$ tree ~/mydeb/

~/mydeb/
├── DEBIAN
└── home
    └── user
        └── test.txt
```
### 4. Создание метаинформация для deb-пакета
#### Описание файлов:
| Имя файла | Описание | Обязательный |
| - | - | - |
| ```DEBIAN/control``` | Центральный файл пакета, который описывает все основные свойства deb-пакета | + |
| ```DEBIAN/copyright``` | Текст лицензии | - |
| ```DEBIAN/changelog``` | История изменений, данную информацию использует dpkg для получения номера версии, ревизии, дистрибутива и важности пакета. [Дополнительная информация](http://www.debian.org/doc/debian-policy/ch-source.html#s-dpkgchangelog) | - |
| ```DEBIAN/rules``` | Правила компиляции, используется когда в файле ```DEBIAN/control``` параметру ```Architeture``` задано значение ```source```. [Дополнительная информация](http://www.debian.org/doc/debian-policy/ch-source.html#s-debianrules) | - |
| ```DEBIAN/conffiles``` | Список файлов конфигурации. В данном файле указывается список файлов которые будут заменять файлы при установки. Если в текущей версии пакета один из этих файлов обновляется, то пользователь получает предупреждение о конфликте версий конфигов, и может выбрать: удалить, заменить, или сделать merge | - |
| ```DEBIAN/dirs``` | Список папок для создания. В данном файле рекомендуется указать все папки которые необходимы для deb-пакета | - |
| ```DEBIAN/menu``` | Создание пунктов меню. Дополнительная информация: ```man5 menufile```. Примеры меню есть в ```/usr/share/applications``` файлы ```*.desktop``` | - |
| ```DEBIAN/md5sums``` | Контрольные суммы файлов. Используется для проверки целостности пакета. Важный файл. Заполняется так: ```$ md5deep -r usr > DEBIAN/md5sums``` | - |
| ```DEBIAN/watch``` | Мониторинг сайта, откуда была скачена прога. Файл содержит инструкции для программ ```uscan``` и ```uupdate```. [Дополнительная информация](http://dehs.alioth.debian.org/) | - |
| ```DEBIAN/cron.d``` | Инсталляция заданий cron. Файл содержит чать crontab для инсталляции | - |
| ```DEBIAN/inid.d``` | init-скрипт | - |
| ```DEBIAN/preinst``` | Выполняется перед установкой пакета: он может подготовить что-либо для успешной установки. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) | - |
| ```DEBIAN/postinst``` | Выполняется сразу после установки пакета: он настраивает установленный пакет так, чтоб он был готов к работе. Здесь также выполняется интерактивная конфигурация пакета: это делается при помощи ```dh_input``` и файла ```DEBIAN/templates```. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) | - |
| ```DEBIAN/prerm``` | Выполняется непосредственно перед удалением пакета: обычно этот скрипт подчищает установочные пути пакета. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) | - |
| ```DEBIAN/postrm``` | Выполняется сразу после удаления пакета: вычищает остатки. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) | - |
| ```DEBIAN/templates``` | Шаблоны для диалогов, который содержит данные, используемые при выводе диалоговых окон (GUI или ncurses) | - |
| ```DEBIAN/config``` | Скрипт через который можно задавать пользователю вопросы: ввести строку, выбрать один из вариантов, поставить галочку и пр. Этим занимается библиотека ```bash``` функций ```debhelper``` пакета ```debconf``` | - |

#### Файл ```DEBIAN/control```
**Основная информация о deb-пакете**
| Атрибут | Класс | Описание | Пример |
| - | - | - | - |
| **Package** | Основной (обязательный) | Имя пакета: [a-zA-Z0-9-] - только латиница, цифры, и дефис. | ```Package: mydeb```  |
| **Version** | Основной (обязательный) | Версия пакета (и программы внутри). Формат принят такой: <версия_программы>-<версия_пакета>. Рекомендую всегда указывать версию пакета: при изменении структуры пакета цифра увеличивается на единичку. Допустимые символы достаточно вольные: можно использовать дату и буквы. | ```Version: 1.0-1 Version: 2009.12.12-1``` |
| Provides | Основной | Имя приложения (возможно, виртуальное), регистрируемое в системе в результате установки этого пакета. Используется редко: в основном, если нужно изменить имя пакета, или если более одного пакета предлагают одинаковый функционал. Например, пакеты Apache и nginx предоставляют возможность демона httpd: ```Provides: httpd```. | ```Provides: supersh``` |
| **Maintainer** | Основной (обязательный) | Имя и почта мэйнтейнера пакета: человека, который «дебианизировал» приложение. Формат произвольный, но принято имя \<e-mail\>. | ```Maintainer: my <my@mail.ru>``` |
| **Architecture** | Основной (обязательный) | Архитектура процессора, для которой предназначен пакет. Допустимые значения: ```i386, amd64, all, source```. ``all`` используется для скриптов, ```source``` используется для компилируемых пакетов с исходниками | ```Architecture: all``` |
| **Section** | Основной (обязательный) | Определяет задачу, для которой приложение обычно используется (группа приложений). Возможные значения: ```admin, base, comm, contrib, devel, doc, editors, electronics, embedded, games, gnome, graphics, hamradio, interpreters, kde, libs, libdevel, mail, math, misc, net, news, non-free, oldlibs, otherosfs, perl, python, science, shells, sound, tex, text, utils, web, x11```. | ```Section: misc``` |
| **Description** | Основной (обязательный) | Описание пакета. Описание состоит из двух частей: короткое описание (70 символов) на той же строке, и длинное описание на последующих строках, начинающихся с пробела. | ```Description: Short. ␣Long ␣goes here. ␣. ␣New line.``` |
| Depends | Связи и зависимости | Список пакетов через запятую, которые требуются для установки этого пакета. После имени пакета можно в круглых скобках указать ограничение на версию, используя операторы: <<, =, >>, <=, >=. Если оператор не указан — используется >= | ```Depends: dpkg, libz (>= 1.2.3), jpeg (= 6b), png (< 2.0)``` |
| Pre-Depends | Связи и зависимости | Список пакетов, которые требуются в процессе установки этого пакета. Эти зависимости могут потребоваться для скриптов установки пакета: например, пакет flash-installer требует wget Можно использовать ограничения на версию (см. Depends). | ```Pre-Depends: wget (>= 1.0)``` |
| Conflicts | Связи и зависимости | Список пакетов, которые не могут быть установлены одновременно с этим. Установка не удастся, если хоть один из перечисленных пакетов уже будет установлен. | ```Conflicts: crapscript``` |
| Replaces | Связи и зависимости | Список пакетов, файлы которых модифицируются этим пакетом. Требуется в случае создания «пакета-патча», изменяющего что-либо: в противном случае при замене файлов чужого пакета возникнет ошибка при установке. | Replaces: example |
| Recommends | Связи и зависимости | Список пакетов, рекомендуемых к установке. Эти пакеты не обязательны, но обычно используются вместе с текущим | ```Recommends: superplatform``` |
| Suggests | Связи и зависимости | Список пакетов, предлагаемых к установке. Эти пакеты не обязательны, но с ними программа работает ещё лучше. По идее, менеджер пакетов должен предлагать установить их. | ```Suggests: supersh-modules``` |
| Build-Depends | Связи и зависимости | Только для ```Architecture: source```. Список пакетов, требуемых для компиляции исходников. То же, что и Depends, но логически отделено. | ```Build-Depends: cmake``` |
| Installed-Size | экстра | Размер файлов пакета в килобайтах. Просто цифра, округлённая до ближайшего целого. Используется менеджером пакетов для определения суммарного требуемого объёма на диске. | ```Installed-Size: 3``` |
| Priority | экстра | Приоритет пакета: насколько он важен в системе. Возможные значения: ```extra, optional, standard, important, required``` (такие пакеты не удаляются вообще!). | ```Priority: optional``` |
| Esssential | экстра | Если установить этот атрибут в значение ```yes```, пакет нельзя будет удалить. | ```Esssential: yes``` |
| Origin | экстра | Строка: откуда получены программы в пакете. Обычно используется URL сайта автора, почта или имя. | ```Origin: brain``` |
| X-Source | экстра | Полная ссылка на \*.tar.gz архив с исходниками | ```X-Source: ...*.tgz``` |

Пример:
```
$ cat ~/mydeb/DEBIAN/control

Package: mydeb
Version: 1.0-1
Section: misc
Architecture: all
Depends: bash
Maintainer: <my@mail.ru>
Description: Super Shell Script
```

#### Файл ```DEBIAN/(preinst|postinst|prerm|postrm)```
**скрипты установки**
| Имя файла | Описание |
| - | - |
| ```DEBIAN/preinst``` | Выполняется перед установкой пакета: он может подготовить что-либо для успешной установки. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) |
| ```DEBIAN/postinst``` | Выполняется сразу после установки пакета: он настраивает установленный пакет так, чтоб он был готов к работе. Здесь также выполняется интерактивная конфигурация пакета: это делается при помощи ```dh_input``` и файла ```DEBIAN/templates```. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) |
| ```DEBIAN/prerm``` | Выполняется непосредственно перед удалением пакета: обычно этот скрипт подчищает установочные пути пакета. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) |
| ```DEBIAN/postrm``` | Выполняется сразу после удаления пакета: вычищает остатки. [Дополнительная ифнормация](http://www.debian.org/doc/debian-policy/ch-maintainerscripts.html#s-mscriptsinstact) |

Ошибки, возникающие в этих скриптах никак ```не логируются```.  
Рекомендую использовать в начале каждого скрипта следующую болванку: она будет сохранять в syslog все возникающие ошибки.  
```
#!/bin/bash
set -e # fail on any error
set -u # treat unset variables as errors

# ======[ Trap Errors ]======#
set -E # let shell functions inherit ERR trap

# Trap non-normal exit signals:
# 1/HUP, 2/INT, 3/QUIT, 15/TERM, ERR
trap err_handler 1 2 3 15 ERR
function err_handler {
local exit_status=${1:-$?}
logger -s -p "syslog.err" -t "mydeb.deb" "mydeb.deb script '$0' error code $exit_status (line $BASH_LINENO: '$BASH_COMMAND')"
exit $exit_status
}

... Ваш код установочного скрипта ...

exit 0
```

#### Файл ```DEBIAN/templates```
**шаблоны для диалогов**  

Файл DEBIAN/templates содержит данные, используемые при выводе диалоговых окон (GUI или ncurses). Файл содержит блоки, разделённые пустой строкой. Каждый блок определяет ресурсы, используемые в одном конкретном диалоговом окне.  
Шапка для всех типов диалогов стандартная:  
```
Template: mydeb/template-name
Type: string
Default: Default-value
Description: Dialog-title
␣Dialog-text
```
| Параметр | Описнаие |
| - | - |
| Template | Уникальный (в пределах одного пакета) идентификатор шаблона. Если в скрипте нужно вызвать определённый диалог - используется именно это имя. |
| Type | Тип шаблона. Определены такие типы: ```string, password, boolean, select, multiselect, text, note, error```. |
| Default-value | значение по умолчанию: пользователь может просто согласиться с ним. |
| Description | Как и в контрольном файле, состоит из двух полей: короткое описание, и длинный текст. Первое - это заголовок «окна», второе - более развёрнутое описание того, что требуется от пользователя. Рекомендуется не использовать слов вроде «введите», а сразу суть: «Приветствие скрипта», «Точка монтирования», ... |

Type:
| Значение | Описание |
| - | - |
| string | Приглашение на ввод текстовой строки. |
| password | Приглашение на ввод пароля. Для этого типа шаблона нет значения Default. |
| boolean | Имеет строковое значение «true» или «false». |
| select | Возможность выбора одного из нескольких вариантов. Варианты предлагаются в дополнительном атрибуте шаблона: ```Choices: yes, no, maybe```. |
| multiselect | Возможность выбора нескольких вариантов галочками. Варианты предлагаются в дополнительном атрибуте шаблона: ```Choices: sex, drugs, rock-n-roll```. |
| text | Выводит на экран текст: некоторая не очень важная информация. Для этого типа шаблона нет значения Default. |
| note | Выводит на экран текст: важная информация. Для этого типа шаблона нет значения Default. |
| error | Выводит на экран текст: очень важная информация, критическая. Для этого типа шаблона нет значения Default. |

#### Файл ```DEBIAN/config```

Основы использования debconf и debhelper:  
```
man 7 debconf-devel
```
Чтобы использовать шаблоны в своём скрипте настройки ```DEBIAN/config```, необходимо сначала подключить функции debhelper:  
```
/usr/share/debconf/confmodule
```
Также этот файл нужно подключить в скрипте ```DEBIAN/postinst```: иначе скрипт DEBIAN/config вообще не выполнится!  
Эти функции доступны в пакете debconf, не забудьте включить его в зависимости!  

Пример использования ```DEBIAN/config```:
```
#!/bin/bash -e

# Подключение команд debconf
. /usr/share/debconf/confmodule

case "$1" in
configure|reconfigure)
# Запрос
db_input medium "mydeb/greeting" || true # инициализация
db_go || true # вывод запроса на экран
# Обработка ответа
db_get "mydeb/greeting" # Получение значения в переменную $RET
greeting="$RET"
echo "$greeting" > /etc/mydeb/greeting.txt
;;
*)
echo "config called with unknown argument \`$1'" >&2
exit 1
;;
esac
# Запрос
db_input medium "mydeb/greeting" || true # инициализация
db_go || true # вывод запроса на экран

# Обработка ответа
db_get "mydeb/greeting" # Получение значения в переменную $RET
greeting="$RET"
echo "$greeting" > /etc/mydeb/greeting.txt
```

Здесь уже кроется неприятная засада: обратите внимание, что функции db_input передаётся приоритет диалога medium. Для debconf можно установить минимальный приоритет: диалоги с приоритетом ниже которого не отображаются, а берётся значение по умолчанию (Default шаблона)! Чтобы этого ТОЧНО не случилось — используем приоритет critical. Кроме того, при установке из GUI порог вывода вопросов выше, и многие из них не отображаются вообще.  
Возможные приоритеты: low - всегда используется default, medium - дефаулт обычно вполне подходит, high - дефаулт нежелателен, critical - внимание пользователя жизненно важно.  
```|| true``` - используется чтобы скрипт не помер из-за ключика "-e" переданного bash.  
В этом скрипте тоже рекомендуется использовать ту болванку для отлова ошибок, иначе с распространяемым пакетом могут возникнуть проблемы при отладке.  
Все тонкости использования debconf (функции, способы, параметры, коды ошибок) описаны в достаточно многословном мане: ```man debconf-devel```.  

И последнее: при удалении пакета командой purge - debconf должен также вычистить из своей базы сведения о пакете. Например, он сохраняет выбор пользователя при запросах db_input.  

Чтобы вычистить эти данные, нужно в postinst-скрипт добавить следующее:  
```
if [ "$1" == "purge" ] && [ -e /usr/share/debconf/confmodule ] ; then
. /usr/share/debconf/confmodule
db_purge
fi
```

### 5. Сборка deb-пакета
Первое, что нужно сделать — это рекурсивно выставить всем файлам в корне пакета пользователя и группу root:root (или другие, если потребуется).  
Это нужно затем, что файлы пакета упаковываются в tar.gz архив который сохраняет и права доступа к файлам, и владельца.  
Потому нужно выполнить:
```
$ sudo chown -R root:root
```
Однако делать это не обязательно. Есть отличная команда ```fakeroot``` которая при создании архива подменит владельца файлос root-ом.  
В нашем примере, скрипт должен иметь бит выполнимости.  

Потом выходим на папку назад, чтоб было видно корневую папку пакета, и пакет создаётся следующей командой:
```
$ cd ~
$ fakeroot dpkg-deb --build mydeb
```
Созданный пакет необходимо переименовать, чтобы он соответствовал порядку именования \*.deb пакетов: <имя пакета>_<версия>_<архитектура>.deb
```
$ mv mydeb.deb mydeb_1.0-1_all.deb
```

### 6. Автоматическая проверка deb-пакета

Существует утилита lintian, позволяющая проверить пакет и выявить типичные ошибки в его структуре. Делается это так:  
```
$ lintian mydeb_1.0-1_all.deb
```

### 7. Установка deb-пакета
```
$ sudo dpkg -i supersh_1.0-1_all.deb
```
